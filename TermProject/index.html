<!--
Group: 19b3b6

First Name: THANNATHON
Last Name: NIRATTISAYKUL
Student ID: 6409682546
E-mail: thannathon.nir@dome.tu.ac.th

First Name: NATTAPORN
Last Name: AIMSUWAN
Student ID: 6409682702
E-mail: nattaporn.aim@dome.tu.ac.th
-->

<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>CS299_Group19b3b6_FinalProject</title>
  <style type="text/css">
    html, body {
      margin: 0;
      height: 100%;
    }
    #c {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
</head>
<body>
  <canvas id="c"></canvas>
  <iframe src="Music.mp3" allow="autoplay" id="iframeAudio"></iframe> 
  <audio autoplay loop  id="playAudio">
      <source src="Music.mp3" type="audio/mp3">
  </audio>
</body>

<script type="module">

  import * as THREE from      'https://threejsfundamentals.org/threejs/resources/threejs/r132/build/three.module.js';
  import {OrbitControls} from 'https://threejsfundamentals.org/threejs/resources/threejs/r132/examples/jsm/controls/OrbitControls.js';
  import {GLTFLoader} from    'https://threejsfundamentals.org/threejs/resources/threejs/r132/examples/jsm/loaders/GLTFLoader.js';
  import {GUI} from           'https://threejsfundamentals.org/threejs/../3rdparty/dat.gui.module.js';

  function main() {

  const canvas = document.querySelector('#c');
  const renderer = new THREE.WebGLRenderer({canvas});
  renderer.shadowMap.enabled = true;
  
  const fov = 45;
  const aspect = 2;  // the canvas default
  const near = 0.1;
  const far = 1000;
  const camera = new THREE.PerspectiveCamera(fov, aspect, near, far);

  camera.position.set(170, 120, -150);

  const controls = new OrbitControls(camera, canvas);
  controls.target.set(0, 5, 0);
  controls.update();

  const scene = new THREE.Scene();
  const dayLoader = new THREE.CubeTextureLoader();
  const dayTexture = dayLoader.load( [ //day texture
          'normal-px.jpg', 
          'normal-nx.jpg',
          'normal-py.jpg',
          'normal-ny.jpg',
          'normal-pz.jpg',
          'normal-nz.jpg'
        ] );

  const nightLoader = new THREE.CubeTextureLoader();
  const nightTexture = nightLoader.load( [ //night texture
          'night-px.jpg', 
          'night-nx.jpg',
          'night-py.jpg',
          'night-ny.jpg',
          'night-pz.jpg',
          'night-nz.jpg'
        ] );
  //scene.background = texture; 

  class ColorGUIHelper {
    constructor(object, prop) {
      this.object = object;
      this.prop = prop;
    }
    get value() {
      return `#${this.object[this.prop].getHexString()}`;
    }
    set value(hexString) {
      this.object[this.prop].set(hexString);
    }
  }
  
  {

    //sunLight
    const sunColor = 0xde9225;
    const sunIntensity = 2;
    const sunDiameter = 300;
    const sunLight = new THREE.PointLight(sunColor , sunIntensity, sunDiameter);
    sunLight.castShadow = true;

    //sun geo and light
    const sunGeometry = new THREE.SphereGeometry( 10, 32, 16 );
    const sunMaterial = new THREE.MeshBasicMaterial({ 
      color: 0xffffff,
    });
    const sun = new THREE.Mesh( sunGeometry, sunMaterial );
    sun.add(sunLight);
    scene.add(sun);
    
    //moonLight
    const moonColor = 0x6171eb;
    const moonIntensity = 0.5;
    const moonDiameter = 300;
    const moonLight = new THREE.PointLight(moonColor, moonIntensity, moonDiameter);
    moonLight.castShadow = true;

    //moon geo
    const textureURL = "https://s3-us-west-2.amazonaws.com/s.cdpn.io/17271/lroc_color_poles_1k.jpg"; 
    const moonTexture = new THREE.TextureLoader().load( textureURL );
    const moonGeometry = new THREE.SphereGeometry( 10, 32, 16 );
    const moonMaterial = new THREE.MeshPhongMaterial({ 
      
      map: moonTexture,
      color: 0xffffff,
      specular: 0x111111,
      shininess: 100,

    });
    const moon = new THREE.Mesh( moonGeometry, moonMaterial );
    moon.castShadow = true;
    scene.add(moon);

    //moon light
    scene.add(moonLight);
    

    //ambientLight
    const light = new THREE.AmbientLight( 0xffffff ,0.5); 
    scene.add( light );


    const gltfLoader = new GLTFLoader();
    gltfLoader.load('CS299_Main.glb', (gltf) => {
      gltf.scene.traverse( function( node ) {

        if ( node.isMesh ) { 
          node.castShadow = true; 
        }

      } );

      gltf.scene.getObjectByName('Field').castShadow = false;
      gltf.scene.getObjectByName('Field').receiveShadow = true;

      const root = gltf.scene;
      scene.add(root);

      // compute the box that contains all the stuff
      // from root and below
      const box = new THREE.Box3().setFromObject(root);
      const boxSize = box.getSize(new THREE.Vector3()).length();
      const boxCenter = box.getCenter(new THREE.Vector3());

      // update the Trackball controls to handle the new size
      controls.maxDistance = boxSize * 10;
      controls.target.copy(boxCenter);
      controls.update();
    });
      
    //GUI
    const options ={
      speed: 0.005,
    }

    const gui = new GUI();
    gui.add(options, 'speed', 0, 0.1);

    //sun_setting
    const sun_controls = gui.addFolder('sun_setting')
    sun_controls.addColor(new ColorGUIHelper(sunLight, 'color'), 'value').name('color'); //sun color GUI
    sun_controls.add(sunLight, 'intensity', 0.5, 4, 0.01);//intensity GUI
    sun_controls.open();

    //moon_setting
    const moon_controls = gui.addFolder('moon_setting')
    moon_controls.addColor(new ColorGUIHelper(moonLight, 'color'), 'value').name('color'); //moon color GUI
    moon_controls.add(moonLight, 'intensity', 0.5, 4, 0.01);
    moon_controls.open();

    var t=0;
    function render(){
      requestAnimationFrame(render);

      if (sun.position.y < 0) { //night
        scene.background = nightTexture;
      } 
      else { // day
        scene.background = dayTexture; 
      }

      t += options.speed;        

      sun.position.x = 150*Math.cos(t) + 0;
      sun.position.y = 150*Math.sin(t) + 0; 

      moon.position.x = -150*Math.cos(t) + 0;
      moon.position.y = -150*Math.sin(t) + 0; 

      moonLight.position.x = -130*Math.cos(t) + 0;
      moonLight.position.y = -130*Math.sin(t) + 0;

      renderer.render(scene, camera);
    }
    requestAnimationFrame(render);
};

  /*
  // create an AudioListener and add it to the camera
  const listener = new THREE.AudioListener();
  camera.add( listener );

  // create a global audio source
  const audio = new THREE.Audio( listener );
  const file = 'Music.mp3';
    
  // load a audio and set it as the Audio object's buffer
  const audioLoader = new THREE.AudioLoader();
  audioLoader.load( 'Music.mp3', function( buffer ) {
    audio .setBuffer( buffer );
    audio .setLoop( true );
    audio .setVolume( 0.5 );
    audio .play();
  });
  */

  function resizeRendererToDisplaySize(renderer) {
    const canvas = renderer.domElement;
    const width = canvas.clientWidth;
    const height = canvas.clientHeight;
    const needResize = canvas.width !== width || canvas.height !== height;
    if (needResize) {
      renderer.setSize(width, height, false);
    }
    return needResize;
  }

  function render() {

    resizeRendererToDisplaySize(renderer);
    {
      const canvas = renderer.domElement;
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.updateProjectionMatrix();
    }
    

    renderer.render(scene, camera); 
    requestAnimationFrame(render); 
  }

  requestAnimationFrame(render);
  
}

  var vid = document.getElementById("playAudio");
  vid.volume = 0.3;

  /*
  var isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
  if (!isChrome){
      $('#iframeAudio').remove()
  }
  // just to make sure that it will not have 2x audio in the background 
  else {
      $('#playAudio').remove() 
  }
  */

main();


</script>
</html>